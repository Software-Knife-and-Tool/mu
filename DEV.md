



<img src="https://github.com/Software-Knife-and-Tool/mu/blob/main/.github/mu.png?raw=true" width="20%" height="%20">

# *mu development*

------

This is quick reference for *mu* developers. 



#### Makefile.dev

------

A separate *makefile* is provided for facilitating *mu* development. The various targets are for developers (mostly the author) who want to modify the system without relying on the *forge* utility.

```
% make -f Makefile.dev
mu project dev makefile -----------------
    emacs - emacs adjuncts
    tests/regression - run the regression suite
    tests/base - run base tests
    tests/current - run current tests
    tests/report - test report
```

The *emacs* target installs a `.dir-locals.el` file in the base directory that provides a *compile* command and generates a TAG file for the *runtime* and utilities sources in `src/`.

The various *test* targets run the test suites.



#### Tools

------

Some additional development tools are sited in the `tools` directory. They include utilities for generating *mu* namespace symbol tables in a variety of formats, a nascent runtime *profiling* utility, and a *valgrind* profiler. Each tool has an accompanying *makefile*.

```
tools
├── crossref
│   ├── Makefile
│   ├── crossref.l
│   └── crossref.py
├── metrics
│   ├── Makefile
│   ├── symbols.l
│   └── symbols.py
├── profiling
│   └── core
│       ├── Makefile
│       └── perf.l
├── reference
│   ├── Makefile
│   ├── reference.l
│   ├── reference.py
│   └── verbose.py
└── valgrind
    ├── Makefile
    └── perf.sh
```



#### Generating the documentation

------

*mu*, *core*, and *utilities* reference cards can be found in ```doc/refcards``` in a variety of formats. They document the *mu*  and *core* namespaces, the runtime API, and options for running *mu-sys* and the *listener* and *forge* utilities.

The *mu* crate rustdoc documentation can be generated by

```
% make -f doc/Makefile
```

and will end up in ```doc/rustdoc```. The ``doc/rustdoc/mu``  subdirectory contains the starting ```index.html```.

The *mu* reference documentation is a collection of *markdown* files in `doc/reference`. To generate the documentation, you will need the *pandoc* utility, see *https://pandoc.org*

Once built, the *html* for the *reference* material is installed in *doc/reference/html*, starting with *index.html*.



#### Building the *mu* system

------

The *mu* runtime is a native code program that must be built for the target CPU architecture. The runtime build system requires only a `rust` development environment, `rust-fmt`, `clippy` and the  GNU `make` utility. Other development tools like  `valgrind` are optional.

Tests, performance, tools, and regression metrics require some version of `python 3`.

```
git clone https://github.com/Software-Knife-and-Tool/mu.git
```

After cloning the *mu* repository, the *mu* system can be built and installed with the supplied makefile. The *world* target builds a release version of the system and the *forge* development tool.  `make` with no arguments prints the available targets. 

```
% make world
```

Having built the distribution, install it in `/opt/mu`.

```
% sudo make install
```

Note: the installation mechanism does not remove the installation directory before writing it and changes to directory structure and files will accumulate.



#### Tests

------

The distribution includes a test suite, shown below. Each suite can be run individually, a *makefile* is provided,  test runners and report generation is accomplished via a nest of *python 3* scripts. Test results are in form of *json* files, they accumulate in the suite `json` directory. Report files are generally found in the suite base directory. 

```
tests
├── footprint
│   ├── Makefile
│   ├── json
│   └── scripts
│       ├── commit.py
│       ├── metrics-ns.py
│       ├── regression.py
│       ├── report-stats.py
│       ├── report.py
│       ├── stats.py
│       └── summary-ns.py
├── performance
│   ├── Makefile
│   ├── json
│   ├── namespaces
│   │   ├── common
│   │   │   ├── boole
│   │   │   ├── core
│   │   │   ├── fixnum
│   │   │   ├── list
│   │   │   └── tests
│   │   ├── core
│   │   │   ├── closure
│   │   │   ├── compile
│   │   │   ├── core
│   │   │   ├── environment
│   │   │   ├── exception
│   │   │   ├── format
│   │   │   ├── lambda
│   │   │   ├── list
│   │   │   ├── macro
│   │   │   ├── reader
│   │   │   ├── stream
│   │   │   ├── string
│   │   │   ├── tests
│   │   │   ├── type
│   │   │   └── vector
│   │   ├── frequent
│   │   │   ├── core
│   │   │   ├── fixnum
│   │   │   ├── float
│   │   │   ├── list
│   │   │   ├── tests
│   │   │   └── vector
│   │   └── mu
│   │       ├── compile
│   │       ├── core
│   │       ├── gcd
│   │       ├── list
│   │       ├── number
│   │       ├── reader
│   │       ├── special-form
│   │       ├── stream
│   │       ├── struct
│   │       ├── symbol
│   │       ├── tests
│   │       └── vector
│   ├── perf.l
│   └── scripts
│       ├── commit.py
│       ├── metrics-ns.py
│       ├── perf-ns.py
│       ├── regression.py
│       ├── report-ns.py
│       ├── report.py
│       └── summary-ns.py
├── profiling
│   └── core
│       ├── Makefile
│       └── core-perf.l
└── regression
    ├── Makefile
    ├── namespaces
    │   ├── common
    │   │   ├── boole
    │   │   ├── common
    │   │   ├── describe
    │   │   │   └── tests
    │   │   ├── fixnum
    │   │   ├── list
    │   │   ├── map
    │   │   ├── metrics
    │   │   │   └── tests
    │   │   ├── sequence
    │   │   └── tests
    │   ├── core
    │   │   ├── backquote
    │   │   ├── closure
    │   │   ├── compile
    │   │   ├── core
    │   │   ├── environment
    │   │   ├── exception
    │   │   ├── fasl
    │   │   │   └── tests
    │   │   ├── format
    │   │   ├── image
    │   │   │   └── tests
    │   │   ├── lambda
    │   │   ├── lisp
    │   │   ├── list
    │   │   ├── macro
    │   │   ├── module
    │   │   ├── prelude
    │   │   ├── reader
    │   │   ├── stream
    │   │   ├── string
    │   │   ├── symbol
    │   │   ├── tests
    │   │   ├── types
    │   │   └── vector
    │   ├── deftype
    │   │   ├── deftype
    │   │   └── tests
    │   ├── module
    │   │   ├── module
    │   │   └── tests
    │   ├── mu
    │   │   ├── backquote
    │   │   ├── compile
    │   │   ├── core
    │   │   ├── exception
    │   │   ├── list
    │   │   ├── namespace
    │   │   ├── number
    │   │   ├── reader
    │   │   ├── special-form
    │   │   ├── stream
    │   │   ├── struct
    │   │   ├── symbol
    │   │   ├── tests
    │   │   └── vector
    │   └── prelude
    │       ├── repl
    │       │   └── tests
    │       └── tests
    ├── summarize-module.py
    ├── summarize-ns.py
    ├── summarize-test.py
    ├── test-module.py
    ├── test-ns.py
    ├── test.py
    └── tests.summary
```



#### Regression Testing

------

The distribution includes a regression test suite, which should be run after every interesting change. The test suite consists of a several hundred individual tests roughly separated by namespace.

Failures in the *mu* tests are almost guaranteed to cause complete failure of subsequent tests.

```
% make tests/base
% make tests/current
% make tests/report
```

The `report` target produces a human readable test report. 

The `tests` makefile has additional facilities for development. The `help` target will list them.

```
% make -C tests/regression help

regression test makefile -----------------

--- test options
    commit - create test summary
    test - run single test group in $NS/$TEST
    summary - run all tests in all namespaces and print summary
    
```

#### Performance metrics

------

Metrics include the average amount of time (in microsconds) taken for an individual test and the number of objects allocated by that test. Differences between runs in the same installation can be in the 20% range. Any changes in storage consumption or a large (20% or greater) increase in test timing warrant examination. Note: `ntests` of 50 seem to demonstrate least variation between runs of identical *mu* binaries.

 The **NTESTS** environment variable (defaults to 20) controls how many passes are included in a single test run.

On a modern Core I7 CPU at 3+ GHz, the default performance tests take around 10 minutes of elapsed time. 

The *makefile* version of the performance and regression tests are included in upcoming releases, but are considered legacy and will eventually be deprecated.

See the *forge* usage section for the equivalent *forge*  `bench` command.

```
% make -C tests/performance base
% make -C tests/performance current
% make -C tests/performance report
% make -C tests/performance commit
```

The `base` target produces a performance run and establishes a baseline. The `current`  target produces a secondary performance run. The `report` target produces a human-readable diff between `base` and `current`.  Normally, you'd run a baseline, make some changes, and then do a current run to see if there were any regressions.

The `performance` makefile has additional facilities for development, including reporting on individual tests. The `help` target will list them. 

In specific, a summary of significant performance changes (differences in measured resource consumption and/or a large difference in average test time between the current summary and the baseline summary.)

```
% make -C tests/performance commit
```

produces a report of the differences between the current summary and the established baseline. The *commit* target reports on any change in storage consumption between the baseline and the current summary.

The  `performance`  makefile offers some development options.

```
% make -C tests/performance help

--- performance options
    namespaces - list namespaces
    list - list tests in $NS
    $NS - run all tests in namespace, unformatted output
    base - run all tests in all namespaces, establish baseline report
    current - run all tests in all namespace, establish current report
    commit - compare current with base, promote current to base
    report - compare current report with base report
    metrics - run tests and verbose report
```



#### Running the *mu* system

------

An interactive session for the extended *mu* system is invoked by the `listener` command.

*rlwrap* makes the *listener* repl much more useful, with command history and line editing.

```
% alias ,listener='rlwrap listener'
```

Depending on your version of *rlwrap*, *,listener* may exhibit odd echoing behavior. Adding

```
set enable-bracketed-paste off
```

to your `~/.inputrc` may help. If you want to run the prelude listener as part of an interactive session:

